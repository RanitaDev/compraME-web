<!-- Formulario sin wrapper de modal (PrimeNG Dialog lo maneja) -->
<form (ngSubmit)="onSubmit()" #categoryForm="ngForm" class="category-form space-y-4 p-2">
  <!-- Nombre de la Categoría -->
  <div class="form-group">
    <label for="nombre" class="block text-sm font-medium text-slate-700 mb-2">
      Nombre de la categoría *
    </label>
    <input type="text"
            id="nombre"
            name="nombre"
            [(ngModel)]="categoryData.nombre"
            #nombreInput="ngModel"
            required
            maxlength="50"
            placeholder="Ej: Electrónicos"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            [class.border-red-300]="nombreInput.invalid && nombreInput.touched">

    <!-- Error del nombre -->
    @if(nombreInput.invalid && nombreInput.touched) {
      <div class="error-message text-red-600 text-sm mt-1 flex items-center gap-1"
      >
        <i class="pi pi-exclamation-triangle text-xs"></i>
        @if (nombreInput.errors?.['required']) { <span>El nombre es requerido</span> }
        @if (nombreInput.errors?.['maxlength']) { <span>Máximo 50 caracteres</span> }
      </div>
    }
  </div>

  <!-- Descripción -->
  <div class="form-group">
    <label for="descripcion" class="block text-sm font-medium text-slate-700 mb-2">
      Descripción *
    </label>
    <textarea
      id="descripcion"
      name="descripcion"
      [(ngModel)]="categoryData.descripcion"
      #descripcionInput="ngModel"
      required
      maxlength="200"
      rows="3"
      placeholder="Describe brevemente esta categoría..."
      class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
      [class.border-red-300]="descripcionInput.invalid && descripcionInput.touched"
    ></textarea>

    <!-- Contador de caracteres y errores -->
    <div class="flex justify-between items-center mt-1">
      @if(descripcionInput.invalid && descripcionInput.touched) {
        <div class="error-message text-red-600 text-sm flex items-center gap-1">
          <i class="pi pi-exclamation-triangle text-xs"></i>
          @if(descripcionInput.errors?.['required']) {
            <span>La descripción es requerida</span>
          }
          @if(descripcionInput.errors?.['maxlength']) {
            <span>Máximo 200 caracteres</span>
          }
        </div>
      }
      <span class="text-xs text-slate-500">
        {{ categoryData.descripcion.length }}/200
      </span>
    </div>
  </div>

  <!-- Imagen de la Categoría -->
  <div class="form-group">
    <label class="block text-sm font-medium text-slate-700 mb-2">
      Imagen de la categoría *
    </label>

    <!-- Zona de carga de imagen -->
    @if(!uploadedImage.preview) {
      <div
        class="upload-zone border-2 border-dashed rounded-lg p-6 text-center transition-all duration-200 cursor-pointer"
        [class.border-blue-400]="isDragging"
        [class.bg-blue-50]="isDragging"
        [class.border-gray-300]="!isDragging"
        [class.hover:border-gray-400]="!isDragging"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()">
        <i class="pi pi-cloud-upload text-3xl mb-2"
           [class.text-blue-500]="isDragging"
           [class.text-gray-400]="!isDragging"></i>
        <p class="text-sm font-medium mb-1"
           [class.text-blue-600]="isDragging"
           [class.text-gray-700]="!isDragging">
          {{ isDragging ? 'Suelta la imagen aquí' : 'Arrastra una imagen o haz clic para seleccionar' }}
        </p>
        <p class="text-xs text-gray-500">PNG, JPG, GIF, WEBP (máx. 2MB)</p>
      </div>
      <input
        #fileInput
        type="file"
        accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
        class="hidden"
        (change)="onFileSelected($event)">
    }

    <!-- Preview de imagen cargada -->
    @if(uploadedImage.preview) {
      <div class="relative">
        <div class="image-preview-container relative rounded-lg border border-gray-200 overflow-hidden">
          <img
            [src]="uploadedImage.preview"
            [alt]="categoryData.nombre || 'Preview'"
            class="w-full h-48 object-cover"
            loading="lazy">

          <!-- Overlay cuando está subiendo -->
          @if(uploadedImage.uploading) {
            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <div class="text-center text-white">
                <i class="pi pi-spin pi-spinner text-2xl mb-2"></i>
                <p class="text-sm">Subiendo...</p>
              </div>
            </div>
          }

          <!-- Botón para eliminar -->
          @if(!uploadedImage.uploading) {
            <button
              type="button"
              class="absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors duration-200"
              (click)="removeImage()"
              title="Eliminar imagen">
              <i class="pi pi-times text-sm"></i>
            </button>
          }
        </div>

        <!-- Info del archivo -->
        @if(uploadedImage.file) {
          <div class="mt-2 text-xs text-gray-600 flex items-center gap-2">
            <i class="pi pi-file"></i>
            <span>{{ uploadedImage.file.name }}</span>
            <span class="text-gray-400">•</span>
            <span>{{ formatFileSize(uploadedImage.file.size) }}</span>
          </div>
        }
      </div>
    }

    <!-- Error de imagen -->
    @if(uploadError) {
      <div class="error-message text-red-600 text-sm mt-2 flex items-center gap-1">
        <i class="pi pi-exclamation-triangle text-xs"></i>
        <span>{{ uploadError }}</span>
      </div>
    }
  </div>

  <!-- Estado Activo -->
  <div class="form-group">
    <label class="flex items-center gap-3 cursor-pointer">
      <input
        type="checkbox"
        name="activa"
        [(ngModel)]="categoryData.activa"
        class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 focus:ring-2">
      <div>
        <span class="text-sm font-medium text-slate-700">Categoría activa</span>
        <p class="text-xs text-slate-500">Las categorías activas son visibles para los usuarios</p>
      </div>
    </label>
  </div>

  <!-- Botones de Acción -->
  <div class="modal-footer flex gap-3 pt-4 border-t border-slate-200">

    <!-- Botón Cancelar -->
    <button
      type="button"
      class="cancel-btn flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors duration-200 font-medium"
      (click)="onCancel()"
    >
      Cancelar
    </button>

    <!-- Botón Guardar -->
    <button
      type="submit"
      class="save-btn flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 font-medium flex items-center justify-center gap-2"
      [disabled]="categoryForm.invalid || isLoading"
    >
      <!-- Loading spinner -->
      @if (isLoading) {
        <i class="pi pi-spin pi-spinner text-sm"></i>
      }

      <!-- Íconos y texto -->
      @if(!isLoading) {
        <ng-container>
          <i class="pi pi-check text-sm"></i>
          <span>{{ isEditMode ? 'Actualizar' : 'Crear' }}</span>
        </ng-container>
      }

      <!-- Texto loading -->
      @if (isLoading) {
        <span *ngIf="isLoading">
          {{ isEditMode ? 'Actualizando...' : 'Creando...' }}
        </span>
      }
    </button>
  </div>
</form>
